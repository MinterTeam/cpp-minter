version: 2.1
commands:
  init:
    steps:
      - run: sudo apt-get update

  checkout_recursive:
    steps:
      - run:
          name: Checkout
          command: git clone --recursive https://github.com/MinterTeam/cpp-minter .
  conan_remotes:
    steps:
      - run: conan remote add -f edwardstock https://api.bintray.com/conan/edwardstock/conan-public
      - run: conan remote add -f bincrafters https://api.bintray.com/conan/bincrafters/public-conan
      - run: conan remote add -f minter https://api.bintray.com/conan/minterteam/minter
      - run: conan user -p $BINTRAY_API_KEY -r minter edwardstock

  conan_project_deps:
    steps:
      - run:
          name: Project dependencies
          command: $(which bash) .circleci/conan_deps.sh

  test:
    steps:
      - run:
          name: Testing
          command: $(which bash) .circleci/test.sh

  deploy_conan:
    steps:
      - run:
          name: Deploy to Conan bintray
          command: $(which bash) .circleci/deploy.sh


  #  make_package:
  #    steps:
  #      - run: bash cfg/package_make.sh -t package
  #      - run: bash _build/package_upload.sh -t bintray

  do_all_centos:
    steps:
      - checkout_recursive
      - conan_remotes
      - conan_project_deps
      - test
      - deploy_conan

  do_all:
    steps:
      - init
      - checkout_recursive
      - conan_remotes
      - conan_project_deps
      - test
      - deploy_conan

jobs:
  #  package_all:
  #    machine:
  #      image: ubuntu-1604:202007-01
  #    steps:
  #      - run: bash cfg/add_repo.sh debian
  #      - run: apt-get install dockerpack
  #      - run: dockerpack build

  gcc-4_8_5:
    docker:
      - image: docker.edwardstock.com/gcc_dev_el7
    steps:
      - do_all_centos

  gcc-5:
    docker:
      - image: conanio/gcc5
        auth:
          username: $DOCKER_USER
          password: $DOCKER_TOKEN
        environment:
          CONAN_CPU_COUNT: 4
    steps:
      - do_all
  gcc-6:
    docker:
      - image: conanio/gcc6
        auth:
          username: $DOCKER_USER
          password: $DOCKER_TOKEN
        environment:
          CONAN_CPU_COUNT: 4
    steps:
      - do_all
  gcc-7:
    docker:
      - image: conanio/gcc7
        auth:
          username: $DOCKER_USER
          password: $DOCKER_TOKEN
        environment:
          CONAN_CPU_COUNT: 4
    steps:
      - do_all
  gcc-8:
    docker:
      - image: conanio/gcc8
        auth:
          username: $DOCKER_USER
          password: $DOCKER_TOKEN
        environment:
          CONAN_CPU_COUNT: 4
    steps:
      - do_all
  gcc-9:
    docker:
      - image: conanio/gcc9
        auth:
          username: $DOCKER_USER
          password: $DOCKER_TOKEN
        environment:
          CONAN_CPU_COUNT: 4
    steps:
      - do_all
  gcc-10:
    docker:
      - image: conanio/gcc10
        auth:
          username: $DOCKER_USER
          password: $DOCKER_TOKEN
        environment:
          CONAN_CPU_COUNT: 4
    steps:
      - do_all

workflows:
  build_and_test:
    jobs:
      - gcc-4_8_5:
          context:
            - remote_tokens
      - gcc-5:
          context:
            - remote_tokens
      - gcc-6:
          context:
            - remote_tokens
      - gcc-7:
          context:
            - remote_tokens
      - gcc-8:
          context:
            - remote_tokens
      - gcc-9:
          context:
            - remote_tokens
      - gcc-10:
          context:
            - remote_tokens
#      - package_all:
#          context:
#            - remote_tokens